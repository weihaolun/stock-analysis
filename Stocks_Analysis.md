# Stocks Analysis with Excel VBA

## I. Overview of Project
### Background
We have been assisting Steve to conduct stocks analysis using Visual Basic Application on Excel. The [dataset](https://github.com/weihaolun/stock-analysis/blob/main/VBA_Challenge.xlsm) for this project contains trading data of 12 stocks for year 2017 and 2018. Initially, Steve was interested in Daqo New Energy Corp (ticker:DQ) and requested us to analyze the performance of this specific stock. However, after seeing the result for DQ, Steve would like to see a thorough analysis of all 12 stocks' volumes and returns so that he can pick the ideal ones to invest. 

To meet Steve's request, the program “All Stocks Analysis” was written in VBA to print out a list of 12 tickers with Total Daily Volume and Return of each. The program user can select either "2017" or "2018" to see the result of that year. Steve can easily do so by clicking a button and inputing the year value.

### Purpose
Program that runs well for 12 stocks may not be efficient enough to run for a larger number of stocks. Therefore, the purpose of this project is to refactor the code and improve the script performance. After refactoring, the program should:
1.	Run faster for the 12 stocks;
2.	Run well for thousands of stocks;
3.  Has an improved code structure.

The following sections of this report include:
1.   Stock Performance Analysis for Steve;
2.   Refactored Script Analysis for us to review the refactoring process;
3.   Summary of pros and cons of refactoring VBA script.

## II. Results
### Stock Performance Analysis
The most important metric to measure the stocks performance in this dataset should be **Return**. Let’s first take a look at **Total Daily Volume 2017 vs. 2018**, then **Return 2017 vs. 2018** to conclude.

Please see the table below for the stocks performance analysis of year 2017 and 2018. 
![stock_analysis_table](https://user-images.githubusercontent.com/84211948/123506937-81bf2b00-d602-11eb-80a8-291e9d9c5419.png)
_(Note: the data in above table are pulled from the tables generated by VBA script, which will be addressed in the next section.)_

**Volume 2017 vs. 2018**
- The top two most traded stocks in 2017 were SPWR and FSLR and they both had significant higher volumes than the other stocks. In 2018, ENPH, SQWR, RUN and FSLR these four stocks all had significant higher volumes than the rest of the stocks. Comparing year over year, both SPWR and FSLR stayed frequently traded.
- According to the **Volume Change YOY** column, 7 out of 12 stocks had increased total volume, which means these 7 stocks were traded more frequently in 2018 than in 2017. Among these 7 stocks, DQ(+201.4%) and ENPH(+173.9%) had the most significant increases in volume. However, since DQ had the lowest volume in 2017, its volume remained very low even after the increase.

**Return 2017 vs. 2018**
- Stocks’ overall performance on returns was good in 2017. Only TERP had a negative return, but -7.2% wasn’t a huge loss. Even though DQ didn’t have a large number of trading volume, a return of +199.4% was very outstanding. In addition, SEDG(+184.5%), ENPH(+129.5%) and FSLR(+101.3%) all had over 100% returns.
- On the other hand, stocks returns in 2018 were mostly negative, only ENPH(+81.9%) and RUN(+84.0%) had positive returns. The most profitable stock of 2017, DQ, became the most lose-out stock of 2018 with a -62.6% return. DQ’s high return in 2017(+199.4%) could be the reason why the trading volume increased by 201.4% in 2018. However, the return wasn’t ideal for the second year.
- Overall, only ENPH's and RUN's returns stayed positive through both years. ENPH’s return decreased compared to +129.5% in 2017, but a +81.9% return was still strong. RUN was very close to breakeven in 2017 with a 5.5% return but reached to +84.0% return in 2018 and became the most profitable stock among the 12. In addition, they were also both traded frequently in 2018, which is generally considered as a good sign for stock market. 
- In conclusion, if Steve would like to pick one or two stocks from this list, ENPH and RUN both looks promising. However, data of only two years might be not sufficient enough to make a decision, there are also many macro factors from the market and economy environment could affect stocks performance. 

*_Pleasea see Appendix section at the end of this report for a visualized [Stock Analysis Dashboard](#appendix)_

### Refactored Script Analysis
As mentioned in above section, in some circumstances, 12 stocks or two years might not be sufficient enough to conduct a deep analysis on stocks performance. Therefore, we need to ensure the program would also run perfectly for large datasets in the future.

The refactored code has been re-structured for this project. In order to measure and compare the original and refactored script, we added another button “**Refactored Analysis for All**” on the sheet to run the code and receive the execution time pop-up message. Please see the screen shot below for example. 

![result_page](https://user-images.githubusercontent.com/84211948/123507106-6a347200-d603-11eb-813d-c72d2ee51180.png)

As a result, the running time of refactored code went down 80%. Please refer to the comparison below.

![graph for report](https://user-images.githubusercontent.com/84211948/123507121-7f110580-d603-11eb-89f0-8cc987349178.png)

Overall, it is because the refactored code only loops over all the rows once.
- We created three storage points to store the data we need for final calculation, which are the following three arrays: tickerVolumes(12), tickerStartingPrices(12) and tickerEndingPrices(12). We also created ticker Index as a counter to count through arrays.
```
tickerIndex = 0

Dim tickerVolumes(12) As Long
Dim tickerStartingPrices(12) As Single
Dim tickerEndingPrices(12) As Single
```
- When looping over all the rows, the following codes are processed, and this is when the data got stored while looping:
```
For i = 2 To Rowcount
    tickerVolumes(tickerIndex) = tickerVolumes(tickerIndex) + Cells(i, 8).Value
    If Cells(i - 1, 1).Value <> tickers(tickerIndex) Then
            tickerStartingPrices(tickerIndex) = Cells(i, 6).Value
    End If
    If Cells(i + 1, 1).Value <> tickers(tickerIndex) Then
            tickerEndingPrices(tickerIndex) = Cells(i, 6).Value
            tickerIndex = tickerIndex + 1
    End If
```
- When we do final calculations for volumes and returns, all data are just pulled from the arrays above instead of going back to the loop to find the variables.
- On the other hand, for the original code, we did not create arrays. Instead, we used variables totalVolume, endingPrice and startingPrice through out the script:
```
For j = 2 To endRow
      If Cells(j, 1).Value = ticker Then
           totalVolume = totalVolume + Cells(j, 8).Value
      End If
      If Cells(j - 1, 1).Value <> ticker And Cells(j, 1).Value = ticker Then
           startingPrice = Cells(j, 6).Value
      End If
      If Cells(j + 1, 1).Value <> ticker And Cells(j, 1).Value = ticker Then
           endingPrice = Cells(j, 6).Value
      End If
 ```
 - Therefore, the data for final calculation cannot be pulled from any memory point, the program need to go back to the loop and retrieve the data from variables.

In this project, arrays are the key to improve script performance. When we have many variables of the same type, using arrays to store these data collections is more efficient. In addition to the fact that array helps to save the memory of the computuer system, it also collects and stores data in a sequential manner and makes it efficient to track data by using the index values. (Singh, 2021)

## III. Summary
### Pros and Cons of Refactoring Code
**Pros**
- Since the purpose of refactoring code is to improve it, so the first advantage of doing is the better performance of the script and program. The refactored script would be very likely to execute faster.
- If refactored code executes faster for a regular dataset, then the code should run well for a much larger dataset without much delay. In another word, refactored code increases the running capability for larger sized data.
- Refactoring can also be a process of reviewing. During this process, it’s a good opportunity to clean up the code and fix potential bugs.
- Once the code is cleaned up and improved, it should have a more organized structure and should be easier to maintain. It could be reused as a standardized script for future similar projects. 
- An organized script is also more convenient for group works. When several teammates working on the same script, it’s better to have a good coding structure that’s readable and understandable for everyone.

**Cons**
- Refactoring code is definitely a time-consuming process. It takes time to alter partial of the code or may cost even more time to refactor the entire script. If there’s not enough time to refactor, test and adjust, refactoring may not necessarily be a good option.
- Refactoring can also be risky. If there’s more than one sets of script in one workbook, or if refactored code is associated with other script's running result, refactoring may cause a series of errors and bugs. 
- Refactoring code for a group project may somehow increase communication cost. We have to ensure that everyone understands the new structure. When refactoring other’s work, we’d better confirm whether there's a reason why the code was written in the original way and whether it’s appropriate to alter it.

### How do these pros and cons apply to refactoring the original VBA script?
**Pros**
- Refactored script definitely decreased execution time for this project. As mentioned in above [section](#refactored-script-analysis), the running time went down 80%. 
- Also, to comply with the purpose of this project, refactored code can work well on larger dataset with thousands of stocks.
- The refactored code is better structured and has increased reusability. If Steve would like to conduct stocks for other years, or add more years, this can be easily done by re-using the code structure.

**Cons**
- The refactoring process did cost more time for me to re-write the code and to fully understand it. 
- My refactoring process did cause bugs. The result from the refactored code was different from the original one. I probably spent more time debugging than refactoring. If the deadline was approaching soon, this could be a big problem. 

In conclusion, this refactoring process was a good practice for beginners. I learned from it that there are always alternative ways to solve one problem, and there are always better solutions if we put more time and thinking into it. Even though it took more time, I’m more confident with the refactored script.

## Appendix
### Stock Analysis Dashboard

![Stock_Analysis_Dashboard](https://user-images.githubusercontent.com/84211948/123497426-2fade380-d5c9-11eb-81d6-d76027a6ee37.png)

### Reference
Singh, A. (2021, April 9). _Advantages of Array: Know The Topmost 10 Significant Benefits Of Array._ EDUCBA.     
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;https://www.educba.com/advantages-of-array/. 

